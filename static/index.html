<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet"
        href="https://neo4j-documentation.github.io/developer-resources/language-guides/assets/css/main.css">
    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"
      />
    <title>COP3530 Project</title>

    <style>
        .table-wrapper {
            position: relative;
            height: 80%;
            overflow: auto;
        }

        .table-wrapper-scroll-y {
            display: block;
        }

        #graph {
            position: absolute;
            top: 5vh;
            left: 40%;
            margin: auto;
            height: 95vh;
            width: 60%;
        }

        .disable-scroll {
            overflow-y: hidden;
            overflow-x: visible;
        }

        .btn-primary {
            color: #ffffff;
            background-color: #0275d8;
            border-color: #357ebd;
        }

        .panel-primary {
            border-color: #0275d8;
        }

        .panel-primary>.panel-heading {
            color: #ffffff;
            background-color: #0275d8;
            border-color: #0275d8;
        }

        .panel-primary>.panel-heading+.panel-collapse .panel-body {
            border-top-color: #0275d8;
        }

        .panel-primary>.panel-footer+.panel-collapse .panel-body {
            border-bottom-color: #0275d8;
        }

        select {
            /* Reset Select */
            appearance: none;
            outline: 0;
            border: 0;
            box-shadow: none;
            /* Personalize */
            flex: 1;
            padding: 0 1em;
            color: #fff;
            background-color: #0275d8;
            background-image: none;
            cursor: pointer;
        }

        /* Remove IE arrow */
        select::-ms-expand {
            display: none;
        }

        /* Custom Select wrapper */
        .select {
            position: relative;
            display: flex;
            width: 15em;
            height: 3em;
            border-radius: .25em;
            overflow: hidden;
        }

        /* Arrow */
        .select::after {
            content: '\25BC';
            position: absolute;
            top: 0;
            right: 0;
            padding: 0.75em;
            background-color: #0275d8;
            transition: .25s all ease;
            pointer-events: none;
        }

        .inline-input-c {
            display: inline-flex;
            flex-wrap: wrap;
            justify-content: space-evenly;
            align-items: center;
            gap: 1vh;
        }
        .form-control {
            width:50%;
        }

        /* Transition */
        .select:hover::after {
            color: white;
        }

        
        .brand {
            color: white;
        }

        .links line {
            stroke: #999;
            stroke-opacity: 0.6;
        }

        .nodes circle {
            stroke: #fff;
            stroke-width: 1.5px;
        }

        .choices__list--multiple .choices__item {
            background-color: #0275d8;
            border: 1px solid #0275d8;
            border-radius: 3px;
        }

        .multi-select-container {
            width:100%;
        }

    </style>
</head>

<body style="height: 100vh; width: 100vw; background: #222;" class="disable-scroll">




    <div style="background:#222; height:5vh; border-bottom-width: 5px; border-bottom-color: #0275d8;" role="navigation"
        class="navbar navbar-default navbar-static-top">
        <div class="container">
            <div class="row">
                <div class="navbar-header col-sm-6 col-md-6">
                    <div class="navbar-brand">
                        <div class="brand">Export Data / Climate Change</div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div style="height:90vh; margin-top: 0; padding-top: 0; width:40%;">
        <div style="margin:0px; height: 100%; width: 100%;" class="container">
            <div style="height:60%; margin-bottom: 3%" class="row">
                <div style="height: 100%" class="col-md-12">
                    <div style="height: 100%" class="panel panel-primary">
                        <div class="panel-heading">Search Box/Algo Selection</div>
    
                            <div class="inline-input-c">

                                <div class="inline-input-c">
                                    
                                    <div class="select">
                                        <select id="reporterNameDropdown">
                                            <option value="None" selected disabled hidden>Select Source Country...</option>
                                        </select>
                                    </div>
                                    <div class="multi-select-container">
                                        <select id="productTypeDropdown" multiple>
                                            <option value="None">Select Products...</option>
                                        </select>
                                    </div>
                                    <div class="multi-select-container">
                                        <select id="partnerNameDropdown" multiple>
                                            <option value="None">Select Partner Country...</option>
                                        </select>
                                    </div>
                                    <button class="btn btn-primary" type="submit" id="search">Search</button>
                                </div>
                                
                            </div>
                            
                        <form role="search" class="navbar-form" id="bfsTraversal">

                            <button class="btn btn-primary" type="button">Perform BFS
                                Traversal</button>
                        </form>
                        <form role="search" class="navbar-form" id="dfsTraversal">

                            <button class="btn btn-primary" type="button">Perform DFS Traversal</button>
                        </form>
                    </div>
                </div>
            </div>
            <div style="height:20%; margin-bottom: 3%" class="row">
                <div style="height: 100%" class="col-md-12">
                    <div style="height: 100%" class="panel panel-primary">
                        <div class="panel-heading">Search Results</div>
                        <div class="table-wrapper table-wrapper-scroll-y">
                            <table style="height: 100%" id="results" class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Movie</th>
                                        <th>Released</th>
                                        <th>Tagline</th>
                                        <th>Votes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div style="height:20%; margin-bottom: 3%;" class="row">
                <div style="height: 100%" class="col-md-12">
                    <div style="height: 100%" class="panel panel-primary">
                        <div class="panel-heading" id="title">Node Details</div>
                        <div class="table-wrapper table-wrapper-scroll-y">
                            <div class="row">
                                <div class="col-sm-4 col-md-4">
                                    <img src="" class="well" id="poster" />
                                </div>
                                <div class="col-md-8 col-sm-8">
                                    <h4>Crew</h4>
                                    <ul id="crew">
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="panel-footer"><button id="vote">Vote</button></div>
                    </div>
                </div>
            </div>
        </div>


    </div>


    <div id="graph">
    </div>

    <script type="text/javascript" src="//code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="https://d3js.org/d3.v3.min.js" type="text/javascript"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script type="text/javascript">
        $(function () {

            function showMovie(title) {
                $.get("/movie/" + encodeURIComponent(title),
                    function (data) {
                        if (!data) return;
                        $("#title").text(data.title);
                        // $("#poster").attr("src", "https://neo4j-documentation.github.io/developer-resources/language-guides/assets/posters/" + encodeURIComponent(data.title) + ".jpg");
                        const $list = $("#crew").empty();
                        data.cast.forEach(function (cast) {
                            $list.append($("<li>" + cast.name + " " + cast.job + (cast.job == "acted" ? " as " + cast.role : "") + "</li>"));
                        });
                        $("#vote")
                            .unbind("click")
                            .click(function () {
                                voteInMovie(data.title)
                            })
                    }, "json");
                return false;
            }
            // function search2(showFirst = true) {
            //     const query = $("#search").find("input[name=search]").val();
            //     $.get("/search?q=" + encodeURIComponent(query),
            //         function (data) {
            //             const t = $("table#results tbody").empty();
            //             if (!data || data.length == 0) return;
            //             data.forEach(function (movie, index) {
            //                 $("<tr><td class='movie'>" + movie.title
            //                     + "</td><td>" + movie.released
            //                     + "</td><td>" + movie.tagline
            //                     + "</td><td id='votes" + index + "'>" + (movie.votes || 0)
            //                     + "</td></tr>").appendTo(t)
            //                     .click(function () { showMovie($(this).find("td.movie").text()); })
            //             });
            //             if (showFirst) {
            //                 showMovie(data[0].title);
            //             }
            //         }, "json");
            //     return false;
            // }

            function voteInMovie(title) {
                $.post("/movie/" + encodeURIComponent(title) + "/vote", () => {
                    search(false);
                    showMovie(title);
                });
            }

            $("#search").click(search);
            $("#dfsTraversal").click();
            
            productSelect = document.getElementById("productTypeDropdown");
            const productChoices = new Choices(productSelect, {maxItemCount: 10, removeItemButton:true, placeholderValue: "Select Product..."});
            partnerSelect = document.getElementById("partnerNameDropdown");
            const partnerChoices = new Choices(partnerSelect, {maxItemCount: 10, removeItemButton:true, placeholderValue: "Select Partner Country..."});
            window.onload = setProductDropdown();
            window.onload = setReporterDropdown();
            window.onload = setPartnerDropdown();
            //window.onload = drawGraph2();


            

            function setReporterDropdown() {

                $.getJSON("/allreportercountries", 
                    function(data) {
                        var count = data["reporterNames"].length;
                        select = document.getElementById('reporterNameDropdown');


                        for (let i=0; i<count; i++){
                            var opt = document.createElement('option');
                            opt.value = data["reporterNames"][i];
                            opt.text = data["reporterNames"][i];
                            select.appendChild(opt);

                        }
                    }

                )
            }

            function setProductDropdown() {

                $.getJSON("/allproducts", 
                    function(data) {
                        console.log(data);
                        productChoices.setChoices(data["productNames"]);
                    }

                )
            }

            function setPartnerDropdown() {

                $.getJSON("/allpartnercountries", 
                    function(data) {
                        console.log(data);
                        partnerChoices.setChoices(data["partnerNames"]);
                    }
                )
            }

            function search() {
                
                reporter = document.getElementById('reporterNameDropdown');
                const reporterName = reporter.value;
                
                const productNames = productChoices.getValue(true);
                const partnerNames = partnerChoices.getValue(true);

                params = {"reporterName":reporterName, "productName":productNames, "partnerNames": partnerNames}
                console.log(params);
                const query = "/countrygraph?q=" + encodeURIComponent(JSON.stringify(params));
                console.log(query);
                //const partnerNames = choices.getValue(true);

                console.log(productNames);
                console.log(reporterName);
                console.log(partnerNames);
                
                $.get(query, function(data) {
                    try {
                        graphdata = JSON.parse(data);
                        console.log(graphdata);
                        drawGraph(graphdata);
                        console.log(graphdata);
                    }
                    catch (error) {
                        console.log('Error parsing JSON:', error, data);
                    }
                })
            
            }


            function drawGraph(data) {
                
                if (data==={}) {
                    console.log("Here");
                    return;
                }
                console.log(data);
                var width = 200 + window.innerWidth * 0.5, height = window.innerHeight * 0.9;
                
                var color = d3.scaleOrdinal(d3.schemeCategory20);

                var simulation = d3.forceSimulation()
                    .force("link", d3.forceLink().id(function (d) { return d.id; }))
                    .force("charge", d3.forceManyBody().strength(-500))
                    .force("center", d3.forceCenter(width / 2, height / 2));
                
                
                const svg = d3.select("#graph").append("svg")
                    .attr("width", "100%").attr("height", "100%")
                    .attr("pointer-events", "all");


                var link = svg.append("g")
                    .attr("class", "links")
                    .selectAll("line")
                    .data(data.links)
                    .enter().append("line")
                    .attr("stroke-width", function (d) { return Math.sqrt(d.value); });

                var node = svg.append("g")
                    .attr("class", "nodes")
                    .selectAll("circle")
                    .data(data.nodes)
                    .enter().append("circle")
                    .attr("r", 10)
                    .attr("fill", function (d) { return color(d.group); })
                    .call(d3.drag()
                        .on("start", dragstarted)
                        .on("drag", dragged)
                        .on("end", dragended));

                node.append("title")
                    .text(function (d) { return d.id; });

                simulation
                    .nodes(data.nodes)
                    .on("tick", ticked);

                simulation.force("link")
                    .links(data.links);

                function ticked() {
                    link
                        .attr("x1", function (d) { return d.source.x; })
                        .attr("y1", function (d) { return d.source.y; })
                        .attr("x2", function (d) { return d.target.x; })
                        .attr("y2", function (d) { return d.target.y; });

                    node
                        .attr("cx", function (d) { return d.x; })
                        .attr("cy", function (d) { return d.y; });
                }
                

                function dragstarted(d) {
                    if (!d3.event.active) simulation.alphaTarget(0.3).restart();
                    d.fx = d.x;
                    d.fy = d.y;
                }

                function dragged(d) {
                    d.fx = d3.event.x;
                    d.fy = d3.event.y;
                }

                function dragended(d) {
                    if (!d3.event.active) simulation.alphaTarget(0);
                    d.fx = null;
                    d.fy = null;
                }
            }

        })

            

        //     function drawGraph(query="") {

        //         if (query="") {
        //             return;
        //         }
        //         console.log(query);
        //         var width = 200 + window.innerWidth * 0.5, height = window.innerHeight * 0.9;
        //         const svg = d3.select("#graph").append("svg")
        //             .attr("width", "100%").attr("height", "100%")
        //             .attr("pointer-events", "all");

        //         var color = d3.scaleOrdinal(d3.schemeCategory20);

        //         var simulation = d3.forceSimulation()
        //             .force("link", d3.forceLink().id(function (d) { return d.id; }))
        //             .force("charge", d3.forceManyBody().strength(-350))
        //             .force("center", d3.forceCenter(width / 2, height / 2));

        //         d3.json(query, function (error, graph) {
        //             if (error) throw error;
                    

        //             var link = svg.append("g")
        //                 .attr("class", "links")
        //                 .selectAll("line")
        //                 .data(graph.links)
        //                 .enter().append("line")
        //                 .attr("stroke-width", function (d) { return Math.sqrt(d.value); });

        //             var node = svg.append("g")
        //                 .attr("class", "nodes")
        //                 .selectAll("circle")
        //                 .data(graph.nodes)
        //                 .enter().append("circle")
        //                 .attr("r", 5)
        //                 .attr("fill", function (d) { return color(d.group); })
        //                 .call(d3.drag()
        //                     .on("start", dragstarted)
        //                     .on("drag", dragged)
        //                     .on("end", dragended));

        //             node.append("title")
        //                 .text(function (d) { return d.id; });

        //             simulation
        //                 .nodes(graph.nodes)
        //                 .on("tick", ticked);

        //             simulation.force("link")
        //                 .links(graph.links);

        //             function ticked() {
        //                 link
        //                     .attr("x1", function (d) { return d.source.x; })
        //                     .attr("y1", function (d) { return d.source.y; })
        //                     .attr("x2", function (d) { return d.target.x; })
        //                     .attr("y2", function (d) { return d.target.y; });

        //                 node
        //                     .attr("cx", function (d) { return d.x; })
        //                     .attr("cy", function (d) { return d.y; });
        //             }
        //         });

        //         function dragstarted(d) {
        //             if (!d3.event.active) simulation.alphaTarget(0.3).restart();
        //             d.fx = d.x;
        //             d.fy = d.y;
        //         }

        //         function dragged(d) {
        //             d.fx = d3.event.x;
        //             d.fy = d3.event.y;
        //         }

        //         function dragended(d) {
        //             if (!d3.event.active) simulation.alphaTarget(0);
        //             d.fx = null;
        //             d.fy = null;
        //         }
        //     }

        // })
    </script>
</body>

</html>